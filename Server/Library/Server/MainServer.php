<?php
/**
 * 主服务器
 *
 * @author: memory<service@im050.com>
 */

namespace Server;

use Handling\RequestHandler;
use Handling\ServerHandler;
use Client\Client;
use Storages\ClientStorage;
use Utils\Config;

class MainServer extends WebSocketServer
{
    protected $port = 8888;
    protected $ip = '0.0.0.0';
    private $_server_handler = null;
    private $clients = [];

    public function __construct($ip = '', $port = '')
    {
        if ($ip == '')
            $ip = Config::get('websocket.host', '0.0.0.0');

        if ($port == '') {
            $port = Config::get('websocket.port');
        }

        parent::__construct($ip, $port);
        $this->_server_handler = new ServerHandler();

    }

    public function onOpen($server, $request)
    {
        $fd = $request->fd;
        $this->clients[$fd] = new Client($fd, $this);
        $clientStorage = new ClientStorage();
        $clientStorage->push($this->clients[$fd]);
    }

    public function onMessage($server, $frame) {
        $fd = $frame->fd;
        $this->_server_handler->hold($this->clients[$fd], $frame);
    }

    public function onClose($server, $fd)
    {

    }

    public function getServer() {
        return $this->server;
    }

    public function broadcast($string) {
        foreach($this->server->connections as $fd) {
            $fdInfo = $this->server->connection_info($fd);
            if ($fdInfo['websocket_status'] == WEBSOCKET_STATUS_FRAME) {
                $this->server->push($fd, $string);
            }
        }
    }

    public function onRequest($request, $response) {

        if (strpos($request->server['request_uri'], '.ico') !== FALSE) {
            return;
        }

        $requestHandler = new RequestHandler($this->server, $request, $response);

        $requestHandler->handleRequest();

    }


    public function start()
    {
        echo "服务启动成功...\r\n监听端口:". $this->port . "\r\n";
        parent::start(); // TODO: Change the autogenerated stub
    }
}